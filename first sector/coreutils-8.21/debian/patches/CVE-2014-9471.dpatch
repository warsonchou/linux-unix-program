#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2014-9471.dpatch by Seth Arnold <seth.arnold@canonical.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Origin: http://debbugs.gnu.org/cgi/bugreport.cgi?msg=11;filename=date-tz-crash.patch;att=1;bug=16872
## DP: Origin: http://debbugs.gnu.org/cgi/bugreport.cgi?msg=19;filename=coreutils-date-crash.patch;att=1;bug=16872
## DP: Combined from previous two URLs, dropping NEWS entries
## DP: Description: parse-datetime: fix crash or infloop in TZ="" parsing
## DP: Author: =?UTF-8?q?P=C3=A1draig=20Brady?= <P@draigBrady.com>


@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' coreutils-8.21~/lib/parse-datetime.y coreutils-8.21/lib/parse-datetime.y
--- coreutils-8.21~/lib/parse-datetime.y	2013-01-02 04:34:46.000000000 -0800
+++ coreutils-8.21/lib/parse-datetime.y	2015-01-08 18:45:33.768522794 -0800
@@ -1303,8 +1303,6 @@
             char tz1buf[TZBUFSIZE];
             bool large_tz = TZBUFSIZE < tzsize;
             bool setenv_ok;
-            /* Free tz0, in case this is the 2nd or subsequent time through. */
-            free (tz0);
             tz0 = get_tz (tz0buf);
             z = tz1 = large_tz ? xmalloc (tzsize) : tz1buf;
             for (s = tzbase; *s != '"'; s++)
@@ -1316,7 +1314,12 @@
             if (!setenv_ok)
               goto fail;
             tz_was_altered = true;
+
             p = s + 1;
+            while (c = *p, c_isspace (c))
+              p++;
+
+            break;
           }
     }
 
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' coreutils-8.21~/tests/misc/date.pl coreutils-8.21/tests/misc/date.pl
--- coreutils-8.21~/tests/misc/date.pl	2013-01-30 16:46:24.000000000 -0800
+++ coreutils-8.21/tests/misc/date.pl	2015-01-08 18:53:26.136401021 -0800
@@ -287,6 +287,13 @@
       {ERR => "date: invalid date '\\260'\n"},
       {EXIT => 1},
      ],
+
+     # From coreutils-5.3.0 to 8.22 inclusive
+     # this would either infinite loop or crash
+     ['invalid-TZ-crash', "-d 'TZ=\"\"\"'",
+      {ERR => "date: invalid date 'TZ=\"\"\"'\n"},
+      {EXIT => 1},
+     ],
     );
 
 # Repeat the cross-dst test, using Jan 1, 2005 and every interval from 1..364.
